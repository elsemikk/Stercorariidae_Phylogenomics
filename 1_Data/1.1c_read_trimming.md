# Read Processing

These are instructions for setting up the raw sequencing reads from whole genome resequencing in preparation for mapping them to a reference genome.  

### Overview

This section details how the raw sequences were trimmed to remove sequencing adapters and low quality bases before mapping to the reference genome.  

### Required Input

This step requires the raw sequencing data (`.fastq.gz` files), which will be available to download from the NCBI SRA (these will be available after publication)  

### Output

The outputs of this step are trimmed sequencing reads ready for downstream mapping steps or for mitogenome assembly. I am making two datasets: the first will only remove adapters, for use in mitogenome assembly. The second will be quality-trimmed in addition to adapter trimming, for all other analyses.  

## Adapter Trimming

Before using our sequencing data for downstream analyses, we need to trim them. There will usually be some sequencing adapter "contamination" in Illumina sequencing reads. This is often from adapter read-through during sequencing, which happens when the length of the read is longer than the insert size of the fragment of DNA being sequenced. To evaluate our levels of adapter contamination, we will use FastQC, which can suggest the sequence of contaminating sequences in the "Overrepreseted sequences" tab of the FastQC output. We already ran FastQC on the raw data in step `1.0`, so now we can view the html files that it produced (stored in `../1.0_datasets/QC`).  

The following overrepresented sequences were found in our Read 2 fastq.gz files of some example samples:  

```
>Parasitic Jaeger
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT GTGGTATG GTGTAGATCT
>Pomarine Jaeger
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT CAGACGTT GTGTAGATCT
>Long-tailed Jaeger
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT ACCTCAGT GTGTAGATCT
>Great Skua
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT CAATCAGG GTGTAGATCT
>Chatham Island Skua
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT CTACAAGG GTGTAGATCT
>Chilean Skua
GATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT AAGCCTGA GTGTAGATCT
```

These sequences are the IDT sequencing adapter, with an 8 bp i5 sample index. These are the sequenced that would be generated by "read-through" of the adapter, in which we would expect to observe the reverse complement of our sequencing adapters.  
We received adapters sequences for our first batch of samples from Genome Quebec (note that IDT2 matches our overrepresented sequences after the first "A"):   

```
>IDT1 Read 1 Sequence
AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC
>IDT2 Read 2 Sequence
AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT

```

These are in fact the reverse complement of the Illumina adapters used in the library.  

Luckily, it is relatively straightforward to trim adapter sequences out of sequencing reads. There are many programs that can do this, but we will trim adapters with Trimmomatic. Comparisons between programs can be found in their publications, and there are also some more informal discussions ex) [here](http://bogdan.org.ua/2016/06/01/practical-comparison-of-ngs-adapter-trimming-tools.html) or [here](https://www.reddit.com/r/bioinformatics/comments/63nu1f/comparing_quality_trimming_and_adapter_removing/). The adapters used in this library prep can be trimmed off using the sequences  found in the file `Trimmomatic-0.39/adapters/TruSeq3-PE-2.fa` which comes with Trimmomatic. Libraries prepared using different adapter sequences will need different files.  
  
Here are the contents of this file, note that it includes the sequences that we noted above (PE1_rc & PE2_rc). Note that it does not include the sample index, but with adapter read-through, the adapter will be read before the sample index, and so trimming at the start of the adapter will necessarily also remove the sample index if it is present at the end of the read.  

```
>PrefixPE/1
TACACTCTTTCCCTACACGACGCTCTTCCGATCT
>PrefixPE/2
GTGACTGGAGTTCAGACGTGTGCTCTTCCGATCT
>PE1
TACACTCTTTCCCTACACGACGCTCTTCCGATCT
>PE1_rc
AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTA
>PE2
GTGACTGGAGTTCAGACGTGTGCTCTTCCGATCT
>PE2_rc
AGATCGGAAGAGCACACGTCTGAACTCCAGTCAC
```

The program NOVOPlasty requires raw reads that have not been quality trimmed, so we will generate an unfiltered, adapterless dataset for NOVOPlasty mitogenome assembly in the next step.

```bash
#some samples are stored in ../1.0_datasets on the node:
#set up environment
mkdir -p /home/0_GENOMES5/Stercorarius/1_Data/1.1_read_trimming
cd /home/0_GENOMES5/Stercorarius/1_Data/1.1_read_trimming
mkdir -p trimlogs

cat read_prefixes | parallel time java -jar /home/0_PROGRAMS/Trimmomatic-0.39/trimmomatic-0.39.jar PE ../1.0_datasets/{1}_R1.fastq ../1.0_datasets/{1}_R2.fastq unfltrd_adaptrlss{1}_R1.fastq.gz unfltrd_adaptrlss{1}_R1_unpaired.fastq.gz unfltrd_adaptrlss{1}_R2.fastq.gz unfltrd_adaptrlss{1}_R2_unpaired.fastq.gz ILLUMINACLIP:/home/0_PROGRAMS/Trimmomatic-0.39/adapters/TruSeq3-PE-2.fa:2:30:7:5:true "2>>" trimlogs/{1}_adaptrim_out.log

#some samples are stored in /home/0_GENOMES1 on the main server:
#cd /home/0_GENOMES1/0_RESEQUENCING_PROJECTS/1_PROCESSED_READS/3_TRIMMED/Stercorariidae
#mkdir -p trimlogs

cat read_prefixes | parallel time java -jar /home/0_PROGRAMS/Trimmomatic-0.39/trimmomatic-0.39.jar PE /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{1}_R1*.fastq.gz /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{1}_R2*.fastq.gz ./unfltrd_adaptrlss{1}_R1.fastq.gz ./unfltrd_adaptrlss{1}_R1_unpaired.fastq.gz ./unfltrd_adaptrlss{1}_R2.fastq.gz ./unfltrd_adaptrlss{1}_R2_unpaired.fastq.gz ILLUMINACLIP:/home/0_PROGRAMS/Trimmomatic-0.39/adapters/TruSeq3-PE-2.fa:2:30:7:5:true "2>" trimlogs/{1}_adaptrim_out.log

#check quality of results, make sure adapters are gone
conda activate fastqc
mkdir -p QC
fastqc unfltrd_adaptrlss*_R*.fastq.gz -t 24 -o QC #will run each sample in parallel on 1 thread each

```
**Timing**: usually takes 96m48 - 271m41 depending on file size.  

## Quality trimming  

In addition to removing adapter sequences, we will also trim to remove low-quality bases for which we have low confidence in their base calls. Read quality decreases towards the [beginninng](http://seqanswers.com/forums/showthread.php?t=61936) and especially the [end](https://www.ecseq.com/support/ngs/why-does-the-sequence-quality-decrease-over-the-read-in-illumina) of the sequencing reads, so we will trim the lowest quality bases there. This can also be done with Trimmomatic, but I am using fastp since it allows for some extra features such as trimming poly-G tails, which is useful since some of my samples are sequenced using NovaSeq technology for which polyG tails can be an issue. These are the steps that I will specify for fastp:   
* first, it will trim all leading (5') bases that are below a quality of 20 (stopping the trim when it finds bases above quality of 20.
* then, it will run a sliding window of 4 bp and cut the read when it encounters a window with average quality below 20, discarding  the trailing (3') end of the read after the cut.  
* next, it will trim poly-G sequences  
* then, it will trim adapter sequences  
* it will keep any read pairs that are both at least 40 bp in length at the end of the trimming  

### Pipeline: trim for quality and remove adapters

Now we will trim each `fastq.gz` sequencing read file. In order to run each one in parallel, we will use a plain text file that lists the prefix of each file that I want to trim: in this case it lists the prefix of the sequencing runs. This includes everything in the filename up to where it specifies whether the read is R1 or R2 (and so not including the `_R1` in the prefix). I can then provide this file to gnu parallel in order to generate commands for each of the listed files.

```bash
mkdir -p /home/0_GENOMES1/0_RESEQUENCING_PROJECTS/1_PROCESSED_READS/3_TRIMMED/Stercorariidae/1.1c_read_trimming
cd /home/0_GENOMES1/0_RESEQUENCING_PROJECTS/1_PROCESSED_READS/3_TRIMMED/Stercorariidae/1.1c_read_trimming #on main server
cd /home/0_GENOMES5/Stercorarius/1_Data/1.1c_read_trimming #on Troglodytes

#generate text file
cat > read_prefixes
#copy paste contents below, press enter, and then ctrl-d
```

My files from different sequencing facilities have different name structures, so I'm using 3 columns: the first is the name of the run, second is the name of the R1 file, and third is the name of the R2 file.  
```
ANSK01_S7_L001 ANSK01_S7_L001_R1_001.fastq.gz ANSK01_S7_L001_R2_001.fastq.gz
ANSK7_S46_L008 ANSK7_S46_L008_R1_001.fastq.gz ANSK7_S46_L008_R2_001.fastq.gz
ANSK8_S8_L001 ANSK8_S8_L001_R1_001.fastq.gz ANSK8_S8_L001_R2_001.fastq.gz
CISK2_S6_L001 CISK2_S6_L001_R1_001.fastq.gz CISK2_S6_L001_R2_001.fastq.gz
CISK3_S1_L001 CISK3_S1_L001_R1_001.fastq.gz CISK3_S1_L001_R2_001.fastq.gz
CISK55_S5_L001 CISK55_S5_L001_R1_001.fastq.gz CISK55_S5_L001_R2_001.fastq.gz
GRSK_MKP1593_S4_L001 GRSK_MKP1593_S4_L001_R1_001.fastq.gz GRSK_MKP1593_S4_L001_R2_001.fastq.gz
HI.4998.001.IDT_i7_18---IDT_i5_18.GRSK_MKP1592 HI.4998.001.IDT_i7_18---IDT_i5_18.GRSK_MKP1592_R1.fastq.gz HI.4998.001.IDT_i7_18---IDT_i5_18.GRSK_MKP1592_R2.fastq.gz
HI.4998.001.IDT_i7_30---IDT_i5_30.POJA_MKP1559 HI.4998.001.IDT_i7_30---IDT_i5_30.POJA_MKP1559_R1.fastq.gz HI.4998.001.IDT_i7_30---IDT_i5_30.POJA_MKP1559_R2.fastq.gz
HI.4998.001.IDT_i7_42---IDT_i5_42.PAJA_B20730 HI.4998.001.IDT_i7_42---IDT_i5_42.PAJA_B20730_R1.fastq.gz HI.4998.001.IDT_i7_42---IDT_i5_42.PAJA_B20730_R2.fastq.gz
HI.4998.001.IDT_i7_54---IDT_i5_54.LTJA_MKP990 HI.4998.001.IDT_i7_54---IDT_i5_54.LTJA_MKP990_R1.fastq.gz HI.4998.001.IDT_i7_54---IDT_i5_54.LTJA_MKP990_R2.fastq.gz
HI.4998.001.IDT_i7_6---IDT_i5_6.CISK_3 HI.4998.001.IDT_i7_6---IDT_i5_6.CISK_3_R1.fastq.gz HI.4998.001.IDT_i7_6---IDT_i5_6.CISK_3_R2.fastq.gz
HI.5011.004.IDT_i7_18---IDT_i5_18.GRSK_MKP1592 HI.5011.004.IDT_i7_18---IDT_i5_18.GRSK_MKP1592_R1.fastq.gz HI.5011.004.IDT_i7_18---IDT_i5_18.GRSK_MKP1592_R2.fastq.gz
HI.5011.004.IDT_i7_30---IDT_i5_30.POJA_MKP1559 HI.5011.004.IDT_i7_30---IDT_i5_30.POJA_MKP1559_R1.fastq.gz HI.5011.004.IDT_i7_30---IDT_i5_30.POJA_MKP1559_R2.fastq.gz
HI.5011.004.IDT_i7_42---IDT_i5_42.PAJA_B20730 HI.5011.004.IDT_i7_42---IDT_i5_42.PAJA_B20730_R1.fastq.gz HI.5011.004.IDT_i7_42---IDT_i5_42.PAJA_B20730_R2.fastq.gz
HI.5011.004.IDT_i7_54---IDT_i5_54.LTJA_MKP990 HI.5011.004.IDT_i7_54---IDT_i5_54.LTJA_MKP990_R1.fastq.gz HI.5011.004.IDT_i7_54---IDT_i5_54.LTJA_MKP990_R2.fastq.gz
HI.5011.004.IDT_i7_6---IDT_i5_6.CISK_3 HI.5011.004.IDT_i7_6---IDT_i5_6.CISK_3_R1.fastq.gz HI.5011.004.IDT_i7_6---IDT_i5_6.CISK_3_R2.fastq.gz
HI.5080.003.IDT_i7_7---IDT_i5_7.CHSK_MKP2451 HI.5080.003.IDT_i7_7---IDT_i5_7.CHSK_MKP2451_R1.fastq.gz HI.5080.003.IDT_i7_7---IDT_i5_7.CHSK_MKP2451_R2.fastq.gz
HI.5080.004.IDT_i7_7---IDT_i5_7.CHSK_MKP2451 HI.5080.004.IDT_i7_7---IDT_i5_7.CHSK_MKP2451_R1.fastq.gz HI.5080.004.IDT_i7_7---IDT_i5_7.CHSK_MKP2451_R2.fastq.gz
POJA_4_S10_L001 POJA_4_S10_L001_R1_001.fastq.gz POJA_4_S10_L001_R2_001.fastq.gz
POJA_IB2659_S9_L001 POJA_IB2659_S9_L001_R1_001.fastq.gz POJA_IB2659_S9_L001_R2_001.fastq.gz
SRR10019934
SRR10019945
ERR4669697
SRR5884877
SRR5884878
SRR5884875
SRR9853758
SRR9853828
SRR9853829
SRR9853830
SRR9853831
```

```bash
#set up directory
cd /home/0_GENOMES1/0_RESEQUENCING_PROJECTS/1_PROCESSED_READS/3_TRIMMED/Stercorariidae/1.1c_read_trimming

#run fastp
#running on the main server
cat read_prefixes | parallel --colsep " " time /home/0_PROGRAMS/fastp -i /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{2} -I /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{3} -o fltrd_adptrlss{1}_R1.fastq.gz -O fltrd_adptrlss{1}_R2.fastq.gz --dont_overwrite --detect_adapter_for_pe --trim_poly_g --cut_front --cut_front_window_size 1 --cut_front_mean_quality 20 --cut_right --cut_right_window_size 4 --cut_right_mean_quality 20 --qualified_quality_phred 15 --unqualified_percent_limit 40 --length_required 40 --correction --overrepresentation_analysis -h {1}.html -j {1}.json #75m16 (94m35) for the last one

#SRA files
cd /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.1c_read_trimming
cat read_prefixes | parallel --colsep " " time /home/0_PROGRAMS/fastp -i /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.0_datasets/{1}_R1.fastq -I /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.0_datasets/{1}_R2.fastq -o fltrd_adptrlss{1}_R1.fastq.gz -O fltrd_adptrlss{1}_R2.fastq.gz --dont_overwrite --detect_adapter_for_pe --trim_poly_g --cut_front --cut_front_window_size 1 --cut_front_mean_quality 20 --cut_right --cut_right_window_size 4 --cut_right_mean_quality 20 --qualified_quality_phred 15 --unqualified_percent_limit 40 --length_required 40 --correction --overrepresentation_analysis -h {1}.html -j {1}.json #81m26.766s

```
Here are details on these fastp settings:  
`-i, --in1`:                            read1 input file name (string [=])  
`-o, --out1`:                           read1 output file name (string [=])  
`-I, --in2`:                            read2 input file name (string [=])  
`-O, --out2`:                           read2 output file name (string [=])  
`--dont_overwrite`:                     don't overwrite existing files. Overwritting is allowed by default.  
`--detect_adapter_for_pe` :             by default, the auto-detection for adapter is for SE data input only, turn on this option to enable it for PE data.  
* "For PE data, fastp will run a little slower if you specify the sequence adapters or enable adapter auto-detection, but usually result in a slightly cleaner output, since the overlap analysis may fail due to sequencing errors or adapter dimers."  
`-g, --trim_poly_g`:                    force polyG tail trimming, by default trimming is automatically enabled for Illumina NextSeq/NovaSeq data  
* Note that I am also trimming poly-G's on the Hiseq samples. Hiseq X uses 4-colour chemistry and does not have the same issue with Poly-G sequences. Nevertheless, I want to treat all samples exactly the same: if some true poly-G's are erroneously trimmed from the Novaseq samples, I also want these same errors repeated in the Hiseq samples to reduce bias.  
`-5, --cut_front`:            move a sliding window from front (5') to tail, drop the bases in the window if its mean quality < threshold, stop otherwise.  
* "If the window size is 1, this is similar as the Trimmomatic LEADING method"   
`-3, --cut_tail`:  move a sliding window from tail (3') to front, drop the bases in the window if its mean quality < threshold, stop otherwise.  
`-r, --cut_right`:            move a sliding window from front to tail, if meet one window with mean quality < threshold, drop the bases in the window and the right part, and then stop.  
`-W, --cut_window_size`:     the window size option shared by cut_front, cut_tail or cut_sliding. Range: 1~1000, default: 4 (int [=4])  
`-M, --cut_mean_quality`: the mean quality requirement option shared by cut_front, cut_tail or cut_sliding. Range: 1~36 default: 20 (Q20) (int [=20])  
`--cut_front_window_size`:   the window size option of cut_front, default to cut_window_size if not specified (int [=4])  
`--cut_front_mean_quality`:  the mean quality requirement option for cut_front, default to cut_mean_quality if not specified (int [=20])  
`--cut_tail_window_size`:    the window size option of cut_tail, default to cut_window_size if not specified (int [=4])  
`--cut_tail_mean_quality`:   the mean quality requirement option for cut_tail, default to cut_mean_quality if not specified (int [=20])  
* "If --cut_right is enabled, then there is no need to enable --cut_tail, since the former is more aggressive. If --cut_right is enabled together with --cut_front, --cut_front will be performed first before --cut_right to avoid dropping whole reads due to the low quality starting bases."  
`--cut_right_window_size`:   the window size option of cut_right, default to cut_window_size if not specified (int [=4])  
`--cut_right_mean_quality`:  the mean quality requirement option for cut_right, default to cut_mean_quality if not specified (int [=20])  
`-q, --qualified_quality_phred`:the quality value that a base is qualified. Default 15 means phred quality >=Q15 is qualified. (int =15)  
`-u, --unqualified_percent_limit`: how many percents of bases are allowed to be unqualified (0-100). Default 40 means 40% (int =40)  
`-n, --n_base_limit`:        if one read's number of N base is >n_base_limit, then this read/pair is discarded. Default is 5 (int =5)  
`-l, --length_required`:     reads shorter than length_required will be discarded, default is 15. (int [=15])  
`-c, --correction`:          enable base correction in overlapped regions (only for PE data), default is disabled  
`--overlap_len_require`:     the minimum length to detect overlapped region of PE reads. This will affect overlap analysis based PE merge, adapter trimming and correction. 30 by default. (int [=30])  
`--overlap_diff_limit`:      the maximum number of mismatched bases to detect overlapped region of PE reads. This will affect overlap analysis based PE merge, adapter trimming and correction. 5 by default. (int [=5])  
`--overlap_diff_percent_limit`:     the maximum percentage of mismatched bases to detect overlapped region of PE reads. This will affect overlap analysis based PE merge, adapter trimming and correction. Default 20 means 20%. (int [=20])  
`-p, --overrepresentation_analysis`:    enable overrepresented sequence analysis.  
`-j, --json`:                           the json format report file name (string [=fastp.json])  
`-h, --html`:                           the html format report file name (string [=fastp.html])  
`-w, --thread`:                         worker thread number, default is 3 (int [=3])  

## Verify results  

After trimming, look at the resulting html files. Since we asked fastp to predict adapter sequences, we should verify that the sequences it detected (if any) were actually adapters. For the most part, it correctly identified adapters. However, it detected `ACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTA`, `CTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACC`, or `CCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAACCCTAAC` for 4 datasets (ANSK7_S46_L008, SRR9853758, SRR9853828, and SRR9853830). These are actually telomeric repeats (the telomeres of many organisms are composed of AACCCT repeats). I will redo these ones without the `--detect_adapter_for_pe` so that fastp doesn't trim off all the telomeric sequences.  

```bash
#redo one focal sample on main server to not trim telomeric repeats
cd /home/0_GENOMES1/0_RESEQUENCING_PROJECTS/1_PROCESSED_READS/3_TRIMMED/Stercorariidae/1.1c_read_trimming
mkdir -p trash
for sample in ANSK7_S46_L008 ; do mv *"$sample"* trash ; done
parallel time /home/0_PROGRAMS/fastp -i /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{1}_R1_001.fastq.gz -I /home/0_GENOMESrawDATA/HISEQX_RESEQUENCED/Stercorariidae/Raw_Genome_Data/{1}_R2_001.fastq.gz -o fltrd_adptrlss{1}_R1.fastq.gz -O fltrd_adptrlss{1}_R2.fastq.gz --dont_overwrite --trim_poly_g --cut_front --cut_front_window_size 1 --cut_front_mean_quality 20 --cut_right --cut_right_window_size 4 --cut_right_mean_quality 20 --qualified_quality_phred 15 --unqualified_percent_limit 40 --length_required 40 --correction --overrepresentation_analysis -h {1}.html -j {1}.json ::: ANSK7_S46_L008

#SRA samples on new server
cd /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.1c_read_trimming
mkdir -p trash
for sample in SRR9853758 SRR9853828 SRR9853830 ; do mv *"$sample"* trash ; done
parallel time /home/0_PROGRAMS/fastp -i /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.0_datasets/{1}_R1.fastq -I /home/1_Else/0_GENOMES5/Stercorarius/1_Data/1.0_datasets/{1}_R2.fastq -o fltrd_adptrlss{1}_R1.fastq.gz -O fltrd_adptrlss{1}_R2.fastq.gz --dont_overwrite --trim_poly_g --cut_front --cut_front_window_size 1 --cut_front_mean_quality 20 --cut_right --cut_right_window_size 4 --cut_right_mean_quality 20 --qualified_quality_phred 15 --unqualified_percent_limit 40 --length_required 40 --correction --overrepresentation_analysis -h {1}.html -j {1}.json ::: SRR9853758 SRR9853828 SRR9853830

#now the files in trash can be deleted
#rm -r trash
```

Now, we have a dataset of reads that have been trimmed for quality and to remove adapters, ready for downstream analyses.  