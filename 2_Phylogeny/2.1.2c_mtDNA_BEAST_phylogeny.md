### Overview
This section details how a time-calibrated phylogeny was constructed for the Stercorariidae mitogenomes.

### Required Input
This step requires the complete, aligned, and annotated mitochondrial genome sequences. This is stored in the file `Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.partitioned.nexus`

### Output
The output is a phylogeny of the mitogenomes, in which branch lengths represent time. The phylogeny is found in `Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.tree`.

# Calibrating the timing of Stercorariidae  

Maximum likelihood trees are generally quick, easy, and reliable, but their downside is that they cannot be directly interpreted in terms of time. The branch lengths of the maximum likelihood tree are proportional to the number of sequence changes that took place along those branches, which should be roughly proportional to time but often not directly interpretable as such. In our case, not all terminal branches reach exactly the same point (the length from the root to the tip is different), possibly because different branches were evolving at slightly different rates (due to variation in mutation and/or selection). This makes it hard to convert between ML branch length and time. Instead, we can use other methods to specifically produce a time-calibrated phylogeny that may be more accurate (but still relies on some major assumptions).

At this point we have a quite confident backbone for the topology of the Stercorariidae tree using maximum likelihood: the first split is between *S. parasiticus*/*S. longicaudus* and the *Catharacta*/*S. pomarinus* clade. We can time-calibrate the phylogeny of the skuas based on our estimate for the date of this node, rather that using a more distant outgroup (Alcids). Note that this is a tertiary calibration: a date estimated based on another estimate based on an estimate based on other data (our Stercorariid tree based on the estimate for the split between Alcids and Stercorariids that was based on fossil calibrations). 

I am calibrating the tree based on the split between the small jaegers (*S. parasiticus* and *S. longicaudus*) and the other skuas, to avoid the difficulties of the very long branch between Stercorariidae and Alcidae (with problems of saturation in mtDNA), and the possibility that the Alcids and Stercorariids differ in their mtDNA mutation rates. We previously estimated a date for this node, with a 95% HDP interval.

First we need to generate a nexus file containing our data. I have an alignment of my taxa that I used to make the ML phylogeny (`Stercorariidae_MitogenomesCorrectedSinglecopy_withOutgroups.mafft.afa`). I am removing the 3 Alcids, removing resulting gap-only columns, and then saving as a nexus file `Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.partitioned.nexus`. 

### Partitioning the dataset

The bird mitogenome contains several protein-coding genes, tRNAs, and rRNAs, as well as some noncoding DNA. It is possible (in fact certain) that these different types of sequence evolve at different rates: protein-coding sequence should change more slowly than noncoding DNA, third codon positions evolve more quickly than first codon positions, etc. To improve the accuracy of our model, we should partition our data into separate categories so that the model can allow them to evolve at different rates. This can be done by adding a "charset" section to a nexus file listing the locations of each partition. I found the location of each gene using the annotation from the Mitos Webserver and by aligning with reference coding sequences from related families (see section on mtDNA assembly). Note that there have been some indels during Stercorariid mtDNA evolution, so some sequences have short gaps - I need to translate between the positions in the annotated mitogenome and in the alignment.

I verified each protein-coding gene by ensuring that none of them contained internal stop codons, and that all of them terminated in stop codons. I aligned reference sequences from NCBI to the alignment in order to check that our annotation captured the expected full length of the protein.

Note there are a few exceptions:
* NAD2, NAD4 and COX3 do not end in a stop codon. They end in "T", and two "A" nucleotides get added to the mRNA in order to form the TAA stop codon.
* NAD3 has an untranslated nucleotide at position 174 (4318 in the full alignment) (between codon position 2 and 3) - I am excluding this basepair from the alignment
* NAD6 must be reverse complemented relative to the alignment, as it is on the opposite strand of all the others. So is tRNAQ, tRNAN, tRNAC

When partitioning the dataset, each basepair can only be placed into a single partition. In bird mtDNA, genes can overlap slightly, so a decision must be made when choosing which partition to place these overlapping basepairs into.
* COX1 overlaps with tRNAS. I will place those basepairs with COX1.
* ATP8 and ATP6 overlap. I will put those basepairs with the smaller ATP8. The partition for ATP6 now starts at codon position 2.
* ATP6 and COX3 overlap. I will put that basepair with COX3.
* NAD4 and NAD4L overlap. I will put those basepairs with NAD4.
* NAD1 overlaps with tRNAI. I will gave that basepair to NAD1.
* rRNA12s overlaps with tRNAF and tRNAV. I will put those basepairs with rRNA. rRNA16S overlaps with tRNAV.
* two tRNAs overlap at 6374, and 15322.

I used Aliview to add the following charset to the nexus file to partition the genes:
```
charset COX1= 1-1551;
charset TRNA= 1552-1616 1619-1687 2374-2443 4076-4144 4501-4569 6239-6308 6309-6374 6375-6444 9422-9491 9506-9575 10121-10192 11382-11451 12457-12507 14112-14185 15172-15241 15252-15322 15323-15390 16430-16501 16503-16571 16585-16658 16661-16727 16728-16797;
charset COX2= 1689-2372;
charset ATP8= 2445-2618;
charset ATP6= 2619-3291;
charset COX3= 3292-4075;
charset NAD3= 4145-4317 4319-4496;
charset NAD4L= 4571-4860;
charset NAD4= 4861-6238;
charset NAD5= 6445-8259;
charset CYTb= 8276-9418;
charset NAD6= 9595-10116;
charset NAD1= 14194-15171;
charset NAD2= 15391-16429;
charset RRNA= 11452-12456 12508-14110;
```
**Effect of partitioning**: to understand the impact of partitioning, I ran a test analysis with the whole mitogenome with no partitions, with a GTR site model. It reached the same topology, but the branch lengths were somewhat different. Visualizing the treeset in Densitree showed that it did not quite converge on any set of branch lengths in the time that I ran it, but rather showed a lot of drastic variation between the sampled trees even after 20 million generations. It might need a lot longer to reach stationary, if it ever would.

**Noncoding DNA**: I am including only genes in this analysis. I could have also included a partition for intergenic DNA, but there is very very little intergenic DNA in the avian mitochondrion - in fact, many genes are overlapping! I also did not include the control region. The control region evolves much more quickly than genes, which makes it useful for very shallow phylogenies (for example, within a population), but also makes it difficult to align between more distant taxa. In Stercorariidae, it has several alignment gaps where there have been apparent duplications and/or deletions in this region. If we did not have enough phylogenetic signal in the coding regions, I might include it, but since I do have sufficient signal (given we have the entire mitogenome), I decided to exclude the control region to avoid these alignment ambiguities and any noise it might introduce. The control region of Stercorariids is also duplicated, further complicating its phylogeny, since it appears to evolve with a pattern of concerted evolution between the duplicates.

Note: I have lumped the rRNAs and tRNAs into single groups to reduce the number of partitions. Here is more detailed information, including the full ranges before I removed overlaps:
```
charset COX1= 1-1551;
charset TRNA= 1543-1616 1619-1687 2374-2443 4076-4144 4501-4569 6239-6308 6309-6374 6374-6444 9422-9491 9506-9575 10121-10192 11382-11452 12436-12508 14112-14185 15170-15241 15252-15322 15322-15390 16430-16501 16503-16571 16585-16658 16661-16727 16728-16797;
charset COX2= 1689-2372;
charset ATP8= 2445-2618;
charset ATP6= 2609-3292;
charset COX3= 3292-4075;
charset NAD3= 4145-4317 4319-4496;
charset NAD4L= 4571-4867;
charset NAD4= 4861-6238;
charset NAD5= 6445-8259;
charset CYTb= 8276-9418;
charset NAD6= 9595-10116;
charset NAD1= 14194-15171;
charset NAD2= 15391-16429;
charset RRNA= 11452-12456 12508-14110;

charset rRNA12s= 11452-12456;
charset rRNA16S= 12508-14110;
charset tRNAF= 11382-11452;
charset tRNAV= 12436-12508;
charset tRNAL= 14112-14185;
charset tRNAI= 15170-15241;
charset tRNAQ= 15252-15322;
charset tRNAM= 15322-15390;
charset tRNAW= 16430-16501;
charset tRNAA= 16503-16571;
charset tRNAN= 16585-16658;
charset tRNAC= 16661-16727;
charset tRNAY= 16728-16797;
charset tRNAS= 1543-1616;
charset tRNAD= 1619-1687;
charset tRNAK= 2374-2443;
charset tRNAG= 4076-4144;
charset tRNAR= 4501-4569;
charset tRNAH= 6239-6308;
charset tRNAS2= 6309-6374;
charset tRNAL2= 6374-6444;
charset tRNAT= 9422-9491;
charset tRNAP= 9506-9575;
charset tRNAE= 10121-10192;
```

After partitioning the mitogenome among genes, I split the genes into first, second, and third codon positions. Since third codon positions are much more likely to be synonymous than first or second codon positions, they generally evolve much faster. Third codon positions from two different genes may have more similar substitution rates than second and third codon positions from the same gene.

To evaluate whether it makes sense to lump the partitions together by codon position rather than by gene, I used partition finder. This is a program that evaluates the best partitioning schemes and substitution models based on a dataset.

First, I converted the nexus file to phylip format in Aliview (`Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.partitioned.phy)`. Then, a wrote a config file and passed the config file to Partition Finder. Note that the config file seems that it must be named `partition_finder.cfg`, as we just pass Partition Finder the name of the folder holding this file.
```bash
cd /home/1_Else/0_GENOMES5/Stercorarius/2_Phylogeny/2.1.2c_mtDNA_BEAST_phylogeny
mkdir partitionfinder
cat > partitionfinder/partition_finder.cfg
```
```
## ALIGNMENT FILE ##
alignment = Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.partitioned.phy;

## BRANCHLENGTHS: linked | unlinked ##
branchlengths = linked;

## MODELS OF EVOLUTION: all | allx | mrbayes | beast | gamma | gammai | <list> ##
models = GTR, GTR+G, GTR+I+G;

# MODEL SELECCTION: AIC | AICc | BIC #
model_selection = aicc;

## DATA BLOCKS: see manual for how to define ##
[data_blocks]
charset COX1_pos1 = 1-1551\3;
charset COX1_pos2 = 2-1551\3;
charset COX1_pos3 = 3-1551\3;
charset COX2_pos1 = 1689-2372\3;
charset COX2_pos2 = 1690-2372\3;
charset COX2_pos3 = 1691-2372\3;
charset ATP8_pos1 = 2445-2618\3;
charset ATP8_pos2 = 2446-2618\3;
charset ATP8_pos3 = 2447-2618\3;
charset ATP6_pos1 = 2621-3291\3;
charset ATP6_pos2 = 2619-3291\3;
charset ATP6_pos3 = 2620-3291\3;
charset COX3_pos1 = 3292-4075\3;
charset COX3_pos2 = 3293-4075\3;
charset COX3_pos3 = 3294-4075\3;
charset NAD3_pos1 = 4145-4317\3 4320-4496\3;
charset NAD3_pos2 = 4146-4317\3 4321-4496\3;
charset NAD3_pos3 = 4147-4317\3 4319-4496\3;
charset NAD4L_pos1 = 4571-4860\3;
charset NAD4L_pos2 = 4572-4860\3;
charset NAD4L_pos3 = 4573-4860\3;
charset NAD4_pos1 = 4861-6238\3;
charset NAD4_pos2 = 4862-6238\3;
charset NAD4_pos3 = 4863-6238\3;
charset NAD5_pos1 = 6445-8259\3;
charset NAD5_pos2 = 6446-8259\3;
charset NAD5_pos3 = 6447-8259\3;
charset CYTb_pos1 = 8276-9418\3;
charset CYTb_pos2 = 8277-9418\3;
charset CYTb_pos3 = 8278-9418\3;
charset NAD6_pos3 = 9595-10116\3;
charset NAD6_pos2 = 9596-10116\3;
charset NAD6_pos1 = 9597-10116\3;
charset NAD1_pos1 = 14194-15171\3;
charset NAD1_pos2 = 14195-15171\3;
charset NAD1_pos3 = 14196-15171\3;
charset NAD2_pos1 = 15391-16429\3;
charset NAD2_pos2 = 15392-16429\3;
charset NAD2_pos3 = 15393-16429\3;
charset RRNA = 11452-12456 12508-14110;
charset TRNA = 1552-1616 1619-1687 2374-2443 4076-4144 4501-4569 6239-6308 6309-6374 6375-6444 9422-9491 9506-9575 10121-10192 11382-11451 12457-12507 14112-14185 15172-15241 15252-15322 15323-15390 16430-16501 16503-16571 16585-16658 16661-16727 16728-16797;

## SCHEMES, search: all | user | greedy | rcluster | rclusterf | kmeans ##
[schemes]
search = greedy;

```
```bash
conda activate py2 #partitionfinder requires python 2.7
python /home/0_PROGRAMS/partitionfinder-2.1.1/PartitionFinder.py partitionfinder --no-ml-tree --force-restart #3 mins
```
Results:  
```
Scheme_step_27 = (COX3_pos1, COX1_pos1, COX2_pos1) (COX2_pos2, COX3_pos2, COX1_pos2) (CYTb_pos3, COX1_pos3, NAD5_pos3, NAD6_pos3) (TRNA) (ATP8_pos3,
 COX3_pos3, COX2_pos3, ATP6_pos3, NAD4_pos3) (ATP8_pos1) (NAD5_pos2, ATP6_pos2, ATP8_pos2, NAD2_pos2) (ATP6_pos1, NAD4_pos1) (NAD1_pos1, CYTb_pos1, 
NAD3_pos1, NAD4L_pos1) (NAD4_pos2, NAD3_pos2, CYTb_pos2, NAD1_pos2, NAD4L_pos2) (NAD1_pos3, NAD3_pos3, NAD4L_pos3, NAD2_pos3) (NAD2_pos1, NAD5_pos1,
 RRNA) (NAD6_pos2) (NAD6_pos1);
```
Partition finder recommends linking various partitions. It always groups codon position 1 with other position 1's, position 2 with position 2's, and position 3 with position 3's. This is not surprising, as codon position 1, 2, and 3 have different levels of conservation. For the most part, COX genes are grouped to each other, and NAD genes are grouped to each other. tRNA is separate, but rRNA is grouped with a couple NAD pos 1. I am not following these exact recommendations, but I will group partitions by codon rather than by gene. Note I am not using the models suggested by partitionfinder, because I am using bmodeltest within BEAST (and the BEAST website discourages users from combining maximum likelihood-based model selection with Bayesian phylogenetic analysis).

Here is my charset, separating genes into codon position 1, 2, and 3.
```
charset pos1 = 1-1551\3 1689-2372\3 2445-2618\3 2621-3291\3 3292-4075\3 4145-4317\3 4320-4496\3 4571-4860\3 4861-6238\3 6445-8259\3 8276-9418\3 9597-10116\3 14194-15171\3 15391-16429\3;
charset pos2 = 2-1551\3 1690-2372\3 2446-2618\3 2619-3291\3 3293-4075\3 4146-4317\3 4321-4496\3 4572-4860\3 4862-6238\3 6446-8259\3 8277-9418\3 9596-10116\3 14195-15171\3 15392-16429\3;
charset pos3 = 3-1551\3 1691-2372\3 2447-2618\3 2620-3291\3 3294-4075\3 4147-4317\3 4319-4496\3 4573-4860\3 4863-6238\3 6447-8259\3 8278-9418\3 9595-10116\3 14196-15171\3 15393-16429\3;
charset RRNA = 11452-12456 12508-14110;
charset TRNA = 1552-1616 1619-1687 2374-2443 4076-4144 4501-4569 6239-6308 6309-6374 6375-6444 9422-9491 9506-9575 10121-10192 11382-11451 12457-12507 14112-14185 15172-15241 15252-15322 15323-15390 16430-16501 16503-16571 16585-16658 16661-16727 16728-16797;
```
I added this charset to the nexus file and named it `Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.codonpartitioned.nexus`


### Setting up an xml file for BEAST
We will be running this analysis in BEAST. BEAST runs by using an xml file, which gives all the parameters and settings needed for the run, which would be too cumbersome to specify over the command line. These xml files can be set up using beauti, a graphical user interface. Normally I try to avoid using GUIs but in this case, there are a great number of parameters to customize, and it is more efficient to make these changes in a GUI when it is for just one analysis. 

Here is how I set up the run in beauti:
Launch Beauti. 
* File -> Import alignment -> Stercorariidae_MitogenomesCorrectedSinglecopy.mafft.codonpartitioned.nexus

**In the Partitions tab**
* this is the mtDNA, it is generally nonrecombining so all mtDNA genes should have the same tree. Select them all and click "link tree" so that all partitions must share the same topology.
* also link clock models for all partitions. A lineage with fast evolution in one will also have fast evolution in the others, but the genes are still allowed to have different partition-specific rates. Giving each partition separate clock models would give too many parameters.

**In the Site Models tab**
For each site model:
* select BEAST Model Test. BEAST will test different models, rather than me needing to guess which one is best.
* check the box to estimate mutation rate (since we have different partitions that evolve at different rates). Uncheck this for just one partition (position1) so that other partitions are relative to that one. (Can't estimate all substitution rates and clock rates at the same time. See here: https://www.beast2.org/2015/06/23/help-beast-acts-weird-or-how-to-set-up-rates.html)
* "fix mean substitution rate" should be automatically checked.

**In the Clock Model tab**
* Optimized relaxed clock
* Clock.rate: 0.01 (starting value of 1% per lineage per million years)

**In the Priors tab:**
* Birth Death model
* ORCRates:Pos1: log normal distribution with mean = 0.01, s=1 (for a broad 95% interval from 0.001 to 0.03, ie, most of the signal should come from the data, not the prior)
Set a prior for divergence dates:
* Go to the Priors tab, scroll to the bottom. -> "Add prior"
* Taxon set label: Jaegers. Select both PAJA and LTJA click ">>", then "OK"
* under Jaegers.prior, select "lognormal". Then click its black arrow. 
* check Mean in real space. M=10.7 Check "Use originate" and "monophyletic". S=0.005 What we have is the 95% interval for the estimate: 10.5-11.9 My. We can use this to obtain a standard deviation for the estimate in our lognormal distribution: `(log(11.452)-log(10.0073))/1.96 = 0.0299`. This is a 95% interval from 10.2-11.2 (it does not perfectly match the posterior distribution of the starbeast3 tree, since it is a different shape, but it is comparable)

**In the MCMC tab**:
* Chain length = 20000000. I used 50000000 in the first round, this was a bit overkill for this particular task, it converged after 10,000,000.

Then click `File -> Save As -> BEAST2.7.xml`
Then you can exit.


Now we can run BEAST. All we need is to provide BEAST with the xml file that we generated. We should run multiple runs starting from different starting seeds, which I generated with a random number generated at `random.org`. This is to verify that all three runs converge to the same result, to reduce the chances of getting stuck on a local optimum. After completing these runs, I opened the log files in Tracer to check that the three files converged to the same likelihood and other parameters, and that they have effective sample sizes (ESS) greater than 200. They did not not have ESS>200 after the first round of 20 million gennerations, so I ran them for another 20 million generations with the `-resume` flag in BEAST - it picks up where it left off.  All ESS should be above 200 ideally. If they are very low, then you may need more iterations, or to rethink your parameters. For example, in one run my Posterior and Prior would not converge (ESS<10 after 40,000,000 gens), but when I simplified my model by switching to the HKY instead of GTR site models, it converged in only 10,000,000 generations. (This time I am using BEAST model test) 

```bash
cd /home/1_Else/0_GENOMES5/Stercorarius/2_Phylogeny/2.1.2c_mtDNA_BEAST_phylogeny


#run BEAST2.7
mkdir -p run_1 && cd run_1
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 1623 -threads 10 ../BEAST2.7.xml
#Total calculation time: 18168.89 seconds
#End likelihood: -28441.87686670738

#replicate to check for convergence
mkdir -p run_2 && cd run_2
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 8728 -threads 10 ../BEAST2.7.xml

mkdir -p run_3 && cd run_3
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
time /home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 7108 -threads 10 ../BEAST2.7.xml

mkdir -p run_4 && cd run_4
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
time /home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 2773 -threads 10 ../BEAST2.7.xml
#Total calculation time: 7431.168 seconds
#End likelihood: -28427.458500239598
#real    123m52.533s
#user    680m17.933s
#sys 278m20.215s

#check preliminary results, evaluate whether the MCMC needs to run for longer
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/logcombiner -log run_1/BEAST2.7.log -log run_2/BEAST2.7.log -log run_3/BEAST2.7.log -o Stercorariidae_MitogenomesCorrectedSinglecopy.3_runs.log -b 10
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/logcombiner -log run_1/BEAST2.7-POS1.trees -log run_2/BEAST2.7-POS1.trees -log run_3/BEAST2.7-POS1.trees -o Stercorariidae_MitogenomesCorrectedSinglecopy.3_runs.trees -b 10
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/treeannotator -heights mean -burnin 0 Stercorariidae_MitogenomesCorrectedSinglecopy.3_runs.trees Stercorariidae_MitogenomesCorrectedSinglecopy.3_runs.tree

#run for longer
mkdir -p run_1 && cd run_1
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 1623 -threads 10 -resume ../BEAST2.7.xml
#Total calculation time: 7690.802 seconds
#End likelihood: -28440.664092312443

#replicate to ensure convergence
mkdir -p run_2 && cd run_2
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 8728 -threads 10 -resume ../BEAST2.7.xml
#Total calculation time: 7695.419 seconds
#End likelihood: -28417.7775080608

mkdir -p run_3 && cd run_3
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
time /home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 7108 -threads 10 -resume ../BEAST2.7.xml
#Total calculation time: 5872.231 seconds
#End likelihood: -28425.333845447636
#real    97m54.503s
#user    560m48.631s
#sys 221m33.674s

mkdir -p run_4 && cd run_4
export LD_LIBRARY_PATH=/home/0_PROGRAMS/miniconda3/pkgs/beagle-lib-3.1.2-h7d875b9_3/lib:$LD_LIBRARY_PATH
time /home/0_PROGRAMS/beast_v2.7.0/beast/bin/beast -seed 2773 -threads 10 -resume ../BEAST2.7.xml


#combine results from the four runs
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/logcombiner -log run_1/BEAST2.7.log -log run_2/BEAST2.7.log -log run_3/BEAST2.7.log -log run_4/BEAST2.7.log -o Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.log -b 10
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/logcombiner -log run_1/BEAST2.7-POS1.trees -log run_2/BEAST2.7-POS1.trees -log run_3/BEAST2.7-POS1.trees run_4/BEAST2.7-POS1.trees -o Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.trees -b 10
/home/0_PROGRAMS/beast_v2.7.0/beast/bin/treeannotator -heights mean -burnin 0 Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.trees Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.tree
#Processing 144004 trees from file.

```
After the runs completed, I examined the log files in Tracer and combined them in Logcombiner. Each of the runs had ESS<200 for some parameters, but when the three runs are combined, all parameters have ESS>200. All three runs converged to the same tree. It looks like all runs reached stationary after the first 10%, so I will just discard the first 10% of each run as burn-in.

After discarding burnin and combining the three runs, I used TreeAnnotator to produce a maximum clade credibility tree.

If using the GUI, these are the steps (I used the command line):
Change the following settings:  
* Burnin percentage: 0 (burn-in has already been discarded when combining the log files)
* Target tree type: maximum clade credibility tree
* Node heights: mean heights
* Input tree file: Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.trees 
* Output file: Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.tree
-> Run  
It should take only seconds.

This is the resulting tree:  
```
#NEXUS

Begin taxa;
    Dimensions ntax=16;
        Taxlabels
            ANSK01
            ANSK7
            ANSK8
            ANSK_NC_026125_1
            CHSK_MKP2451
            CISK2
            CISK3
            CISK55
            GRSK_MKP1592
            GRSK_MKP1593
            LTJA_MKP990
            PAJA_B20730
            PAJA_USNM606730
            POJA_4
            POJA_IB2659
            POJA_MKP1559
            ;
End;
Begin trees;
    Translate
           1 ANSK01,
           2 ANSK7,
           3 ANSK8,
           4 ANSK_NC_026125_1,
           5 CHSK_MKP2451,
           6 CISK2,
           7 CISK3,
           8 CISK55,
           9 GRSK_MKP1592,
          10 GRSK_MKP1593,
          11 LTJA_MKP990,
          12 PAJA_B20730,
          13 PAJA_USNM606730,
          14 POJA_4,
          15 POJA_IB2659,
          16 POJA_MKP1559
;
tree TREE1 = ((((((1[&height=1.1375152491965091E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.06024001772934347,length_95%_HPD={0.02889481851808995,0.09389279894786284},length_median=0.05835402715940052,length_range={0.012370954141525559,0.40730259096343957},rate=0.0074618303390797175,rate_95%_HPD={0.004410978526313813,0.010979231881291211},rate_median=0.007261840417927744,rate_range={0.0010471527017080215,0.03284733418323136}]:0.060240017729343655,3[&height=1.1375152491965091E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.06024001772934347,length_95%_HPD={0.02889481851808995,0.09389279894786284},length_median=0.05835402715940052,length_range={0.012370954141525559,0.40730259096343957},rate=0.007048768750590941,rate_95%_HPD={0.004100311511101296,0.010258578806848821},rate_median=0.006925338584723855,rate_range={0.0010531919566280931,0.025949796407042886}]:0.060240017729343655)[&height=0.06024001772934479,height_95%_HPD={0.028894818518091725,0.09389279894786462},height_median=0.05835402715940052,height_range={0.012370954141529111,0.40730259096344135},length=0.036470075191658534,length_95%_HPD={0.008783449682997713,0.06788762373181889},length_median=0.03410308496844827,length_range={0.0015741768355361785,0.636554174355167},posterior=1.0,rate=0.0071385821574902735,rate_95%_HPD={0.004034296839812484,0.010493759261110392},rate_median=0.00699648728373424,rate_range={6.1267528178044E-4,0.0260071872296537}]:0.0364697368871345,2[&height=1.1392915566940344E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.09671003597783463,length_95%_HPD={0.05546843951242586,0.14142938131008798},length_median=0.09419869684795312,length_range={0.030407254002222217,0.941627286816134},rate=0.006560995952401306,rate_95%_HPD={0.0037977723525074846,0.009450705903802722},rate_median=0.006516881779667231,rate_range={6.018887716492837E-4,0.027528804020929457}]:0.09670975461647816)[&height=0.0967097546164793,height_95%_HPD={0.055315124291718476,0.14127142139536097},height_median=0.09419869684795401,height_range={0.030407254002222217,0.941627286816134},length=0.03690277386886681,length_95%_HPD={0.006715956526921474,0.07191391040199768},length_median=0.0340444633071435,length_range={6.299398314251192E-4,0.3979953195342052},posterior=0.9999861114969029,rate=0.006907198024885836,rate_95%_HPD={0.0037729494023522854,0.010088793971923136},rate_median=0.006802082810577866,rate_range={1.8961490098927194E-4,0.024907415554151772}]:0.03501853724938053,(4[&height=1.1344560529507711E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.0644947806856981,length_95%_HPD={0.03321103722539043,0.09928213388042373},length_median=0.06248873878014649,length_range={0.015099196170762497,0.5821024706694669},rate=0.006947742201924127,rate_95%_HPD={0.004002369257431277,0.010051992130131724},rate_median=0.006849589354976932,rate_range={8.06204116659085E-4,0.021209533223561283}]:0.06479119581496388,(5[&height=1.1323590232661925E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.049476992285363,length_95%_HPD={0.022152121739873465,0.07907257508529142},length_median=0.04770601973463773,length_range={0.008455824980480031,0.4653152841405781},rate=0.007066380237363203,rate_95%_HPD={0.004049313890077334,0.010303396874381998},rate_median=0.006936316205570624,rate_range={4.404858727076158E-4,0.026963713956972106}]:0.04909692120393366,(7[&height=1.131791591704483E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.00428006415020302,length_95%_HPD={7.286951664298158E-8,0.012838060046929556},length_median=0.002947726878506529,length_range={7.286951664298158E-8,0.09513516078594719},rate=0.006932408927844634,rate_95%_HPD={0.0037948638430457954,0.010232549253784074},rate_median=0.006825460611129198,rate_range={3.073464212534572E-4,0.025350845365899793}]:0.0042800641502029856,8[&height=1.131791591704483E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.00428006415020302,length_95%_HPD={7.286951664298158E-8,0.012838060046929556},length_median=0.002947726878506529,length_range={7.286951664298158E-8,0.09513516078594719},rate=0.006938208600245611,rate_95%_HPD={0.0038033103493826017,0.010244615142569897},rate_median=0.006829839492548012,rate_range={4.6866515388515234E-4,0.02616100167418899}]:0.0042800641502029856)[&height=0.0042800641502041175,height_95%_HPD={7.286951664298158E-8,0.012838060046931332},height_median=0.0029477268785091937,height_range={7.286951664298158E-8,0.09513516078594719},length=0.04521337307334197,length_95%_HPD={0.018649631635977215,0.074787101594886},length_median=0.043463295439950755,length_range={0.005273805173429125,0.43548692264838174},posterior=1.0,rate=0.007157425359573896,rate_95%_HPD={0.004045894661420981,0.01037830956166607},rate_median=0.0070179823694843345,rate_range={7.432695894640471E-4,0.023817151374483328}]:0.044816857053730674)[&height=0.049096921203934794,height_95%_HPD={0.02222756460795594,0.07841436821842507},height_median=0.0473914348612956,height_range={0.008455824980480031,0.4653152841405781},length=0.01575241047355887,length_95%_HPD={1.7654060256333537E-4,0.03670991545196145},length_median=0.013457960306106465,length_range={8.554718604614209E-7,0.24090782566357838},posterior=0.9622510485819838,rate=0.006911683324727834,rate_95%_HPD={0.003833129030109224,0.010247983333511984},rate_median=0.006808537919855005,rate_range={4.3716050904873065E-4,0.03650220880006841}]:0.015694274611030228)[&height=0.06479119581496502,height_95%_HPD={0.03337168274644675,0.09928447902569992},height_median=0.0627660100081826,height_range={0.015099196170764273,0.5821024706694669},length=0.06948033452903808,length_95%_HPD={0.02780645713847285,0.11463030151166897},length_median=0.0667489997130346,length_range={0.008247281290799435,0.6969616334080921},posterior=1.0,rate=0.007079774036558439,rate_95%_HPD={0.0040605197171982325,0.010311623106546488},rate_median=0.00695167333537758,rate_range={6.412726727593395E-4,0.03047503737341791}]:0.0669370960508948)[&height=0.13172829186585983,height_95%_HPD={0.08164148067710641,0.18513803807331186},height_median=0.1284442805718733,height_range={0.04407580018633617,1.1388315947328866},length=0.016982860799871862,length_95%_HPD={1.813212922030516E-6,0.04483815598346297},length_median=0.013366890717867008,length_range={1.6317009308153274E-6,0.6623353211653473},posterior=0.5578317268964751,rate=0.006872214643084624,rate_95%_HPD={0.003625119066743992,0.010065260557687236},rate_median=0.006783565753870874,rate_range={3.748363979349724E-4,0.02705610624718877}]:0.01400731052370971,6[&height=1.1351468391998086E-15,height_95%_HPD={0.0,1.7763568394002505E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.141095382412113,length_95%_HPD={0.08615318650859116,0.20268906834770206},length_median=0.1372863627873695,length_range={0.04829040759262604,1.2548251927066172},rate=0.006791369551541145,rate_95%_HPD={0.0038879704075410726,0.009616778737301834},rate_median=0.006725978193426941,rate_range={4.619638615145945E-4,0.02130799961063992}]:0.1457356023895684)[&height=0.14573560238956954,height_95%_HPD={0.08946682353256996,0.20528005113506786},height_median=0.14201287467532975,height_range={0.050570286099675954,1.2548251927066172},length=0.9304057920947788,length_95%_HPD={0.5953390065649842,1.297289735517058},length_median=0.9103123273746245,length_range={0.2035039344828551,4.225391191772427},posterior=1.0,rate=0.00687786297821012,rate_95%_HPD={0.0040177365336931045,0.009700826716939868},rate_median=0.0067911649830195734,rate_range={0.0011389718865724824,0.025224139667020626}]:0.9304057920947963,((9[&height=1.1369478176347996E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.0046322290174333185,length_95%_HPD={1.9618628499529223E-8,0.01418634634378968},length_median=0.0031221732065587204,length_range={1.9618628499529223E-8,0.11717047161628891},rate=0.006926899029037773,rate_95%_HPD={0.0037275014881566594,0.0101800402112507},rate_median=0.006815950289475032,rate_range={2.597777851594088E-4,0.02364088820720511}]:0.004632229017433332,10[&height=1.1369478176347996E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.0046322290174333185,length_95%_HPD={1.9618628499529223E-8,0.01418634634378968},length_median=0.0031221732065587204,length_range={1.9618628499529223E-8,0.11717047161628891},rate=0.006928778526237235,rate_95%_HPD={0.0037778258562123678,0.01021591490538352},rate_median=0.006819269217553918,rate_range={4.852728751128038E-4,0.026866043943512836}]:0.004632229017433332)[&height=0.0046322290174344695,height_95%_HPD={1.9618630275886062E-8,0.014186346343791456},height_median=0.003122173206560497,height_range={1.9618630275886062E-8,0.11717047161628891},length=0.3495774791577528,length_95%_HPD={0.21456705097523887,0.49912015458896875},length_median=0.3411278094489365,length_range={0.10647722977278384,2.8027722913260984},posterior=1.0,rate=0.007644112365994492,rate_95%_HPD={0.0047076722502931625,0.010929108489258958},rate_median=0.007456713457772395,rate_range={0.0010838015222249878,0.026184053752071397}]:0.34957747915776083,((14[&height=1.1404140843487206E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.04601741122784943,length_95%_HPD={0.01860478203388638,0.07753227187194334},length_median=0.04399752812594748,length_range={0.006790366738368192,0.5256547365572128},rate=0.006504167420268349,rate_95%_HPD={0.003504880778624227,0.009420848130261136},rate_median=0.00647075375927193,rate_range={4.340618933092469E-4,0.022291488981351748}]:0.04601628844466761,16[&height=1.1404264198174534E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.04601715588430094,length_95%_HPD={0.018612592263917094,0.07753227187194334},length_median=0.04399752812594748,length_range={0.006790366738368192,0.5256547365572128},rate=0.007602079769138769,rate_95%_HPD={0.0043647322058041615,0.01125718682344261},rate_median=0.007361588100583001,rate_range={9.334752624089483E-4,0.03043401960860123}]:0.04601628844466761)[&height=0.04601628844466875,height_95%_HPD={0.018614916687520022,0.07752975590915057},height_median=0.04399645187491252,height_range={0.006790366738369968,0.5256547365572146},length=0.0283888106657841,length_95%_HPD={0.0028839909659410523,0.05931349440233902},length_median=0.025467228292187727,length_range={2.2308698293116436E-4,0.829422176671244},posterior=0.9999583344907086,rate=0.006874784819295131,rate_95%_HPD={0.0037878301214071654,0.010136642117171989},rate_median=0.006778910842074611,rate_range={1.102614998172152E-4,0.032387567908966144}]:0.028388845010058547,15[&height=1.138391067476539E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.07440468932048012,length_95%_HPD={0.03625097646489195,0.11727179436771706},length_median=0.07161711740065346,length_range={0.018476130526778434,1.0875469486867981},rate=0.006943322476051871,rate_95%_HPD={0.003993983755688471,0.010027625223350801},rate_median=0.006843500260515853,rate_range={2.773897044791785E-4,0.023630656390224006}]:0.07440513345472616)[&height=0.0744051334547273,height_95%_HPD={0.03625097646489195,0.11727179436771884},height_median=0.0716175412470923,height_range={0.01847613052678021,1.0875469486867981},length=0.27980457472046644,length_95%_HPD={0.15326469874195503,0.41745169505598945},length_median=0.2719486776819915,length_range={0.06099002916091756,2.427776579097415},posterior=1.0,rate=0.006726395180581293,rate_95%_HPD={0.00389602322123385,0.009629435175110272},rate_median=0.006646646277632935,rate_range={8.116430298448247E-4,0.027130217423949998}]:0.27980457472046805)[&height=0.3542097081751953,height_95%_HPD={0.21798189298862525,0.504040961823538},height_median=0.34561240953915995,height_range={0.11429077125173848,2.863451552469387},length=0.7219316863091643,length_95%_HPD={0.4179980476619196,1.0458741372144633},length_median=0.7026409762488433,length_range={0.13388014121633063,4.126950115462812},posterior=1.0,rate=0.007229893508890714,rate_95%_HPD={0.004198437907593533,0.010429514104962397},rate_median=0.007076154321144867,rate_range={0.0011955869058401616,0.026964604251494752}]:0.7219316863091705)[&height=1.0761413944843659,height_95%_HPD={0.7101685147896433,1.4607447332796237},height_median=1.054305998731329,height_range={0.33945017459877747,5.480216384479045},length=9.605547889056654,length_95%_HPD={8.941628559491157,10.2965365923594},length_median=9.608036828529137,length_range={5.366770863866588,11.085098310764177},posterior=1.0,rate=0.0072676465576230085,rate_95%_HPD={0.005339026923835697,0.009403269259988262},rate_median=0.007208159083004372,rate_range={0.0012858586568164623,0.014239042755313345}]:9.605547889056542,(11[&height=1.1382307063830124E-15,height_95%_HPD={0.0,1.7763568394002505E-15},height_median=1.7763568394002505E-15,height_range={0.0,3.552713678800501E-15},length=6.692613607712566,length_95%_HPD={4.787903882456482,8.658505578313383},length_median=6.64899628900749,length_range={1.6061991285525998,11.472431173682004},rate=0.00661639771134007,rate_95%_HPD={0.004570986114949766,0.008745370972523528},rate_median=0.00653770722024871,rate_range={0.003122311027588294,0.027510974312549796}]:6.692613607712566,(12[&height=1.1372932107593185E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.13684253758491025,length_95%_HPD={0.07179494467631642,0.21138776033292572},length_median=0.1319426562421837,length_range={0.03277230788025243,1.7985244839704517},rate=0.006710490226592325,rate_95%_HPD={0.003667579758960699,0.009741465314366116},rate_median=0.006646021883880044,rate_range={1.2819632936234858E-4,0.021726119367892132}]:0.13684253758491036,13[&height=1.1372932107593185E-15,height_95%_HPD={0.0,3.552713678800501E-15},height_median=1.7763568394002505E-15,height_range={0.0,5.329070518200751E-15},length=0.13684253758491025,length_95%_HPD={0.07179494467631642,0.21138776033292572},length_median=0.1319426562421837,length_range={0.03277230788025243,1.7985244839704517},rate=0.007390288464856451,rate_95%_HPD={0.004160065070930433,0.01083150953790467},rate_median=0.007194845461479884,rate_range={8.344847253739037E-4,0.038886303333659784}]:0.13684253758491036)[&height=0.1368425375849115,height_95%_HPD={0.07179494467631642,0.2113877603329275},height_median=0.1319426562421846,height_range={0.03277230788025243,1.7985244839704517},length=6.5557710701276255,length_95%_HPD={4.65621731034309,8.499037663000935},length_median=6.513121214957727,length_range={1.4966075748412884,11.217435366846662},posterior=1.0,rate=0.008002946368593397,rate_95%_HPD={0.005570979146151993,0.010734177289131203},rate_median=0.007826856552482907,rate_range={0.004140648900931288,0.03481109293904123}]:6.555771070127656)[&height=6.692613607712567,height_95%_HPD={4.787903882456482,8.658505578313385},height_median=6.648996289007492,height_range={1.6061991285526016,11.472431173682006},length=3.989075675828584,length_95%_HPD={2.0372197086337938,5.8604496078989605},length_median=4.0213753156199505,length_range={1.565845588675785E-4,8.769875334127871},posterior=1.0,rate=0.0070688842181055155,rate_95%_HPD={0.004282720904700608,0.009993231430383775},rate_median=0.006986358526020699,rate_range={4.7545144913144585E-4,0.02610983985490738}]:3.9890756758283397)[&height=10.681689283540907,height_95%_HPD={10.049751277537801,11.298032139226336},height_median=10.67621762059549,height_range={9.292418194045224,12.154510486246119},length=0.0,posterior=1.0,rate=1.0]:0.0;
End;

```
Most nodes have 100% posterior probability, except for two within "Catharacta".

I am viewing the tree in Figtree
* File -> Open -> Stercorariidae_mitogenome.tre
* Check "Node labels"
* "Node labels", "Display": posterior, then height_95%_HDP 
* Check "Scale axis", uncheck "Show grid", check "Reverse axis"


## Visualize trees
Lets look at the trees in densitree:

File -> Load -> Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.trees
Burnin -> 0
Export -> mtDNA_BEAST_phylogeny_densitree.png

If it ran for long enough and was reasonable, then you should see a single unambiguous tree clearly represented by most samples. If there is uncertainty at some nodes you may see some discordance. Remember that this is the mtDNA: it should only have one "true" tree, so uncertainty should be just due to real *uncertainty*, not conflicting gene genealogies due to introgression or ILS. It looks like it did converge to a single phylogeny.


## Archive results
Compress large text files to save space once the project is complete.
```bash
gzip -9 Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.log
gzip -9 Stercorariidae_MitogenomesCorrectedSinglecopy.4_runs.trees
gzip -9 run_1/*
gzip -9 run_2/*
gzip -9 run_3/*
gzip -9 run_4/*

#make a nexus file for TreeBase, following their ibstructions for generating the nexus in Mesquite. Edit with more readable sample labels.
sed 's/LTJA_MKP990/Stercorarius_longicaudus_MKP990/g; s/PAJA_B20730/Stercorarius_parasiticus_B20730/g; s/PAJA_USNM606730/Stercorarius_parasiticus_USNM606730/g; s/POJA_MKP1559/Stercorarius_pomarinus_MKP1559/g; s/POJA_IB2659/Stercorarius_pomarinus_IB2659/g; s/POJA_4/Stercorarius_pomarinus_4/g; s/GRSK_MKP1592/Stercorarius_skua_MKP1592/g; s/GRSK_MKP1593/Stercorarius_skua_MKP1593/g; s/CISK55/Stercorarius_antarcticus_5/g; s/CISK2/Stercorarius_antarcticus_2/g; s/CISK3/Stercorarius_antarcticus_3/g; s/CHSK_MKP2451/Stercorarius_chilensis_MKP2451/g; s/ANSK8/Stercorarius_maccormicki_8/g; s/ANSK01/Stercorarius_maccormicki_10/g; s/ANSK7/Stercorarius_maccormicki_7/g; s/ANSK_NC_026125_1/Stercorarius_maccormicki_NC026125/g' TreeBase.mafft.codonpartitioned.nexus > temp
mv temp TreeBase_BEAST2.7_Mitochondrial_Phylogeny.nex
```
